---
title: "R Notebook"
output: html_notebook
---


# Init
```{r}
reqpkg = c("plyr","BiocParallel","doParallel", "DESeq2", "foreach", "ggplot2", 
   "gridExtra","scales", "phyloseq",  "tidyr", 
           "reshape2", "vegan", "dplyr")
# Load all required packages and show version
for (i in reqpkg) {
    print(i)
    print(packageVersion(i))
    suppressMessages(library(i, quietly = TRUE, verbose = FALSE, 
                             warn.conflicts = FALSE, character.only = TRUE))
}
```

## Set file paths
```{r}
workDir = '/home/bryan/PennRhiz/data/run1/DeSeq2/'
#using physeq file with sparsity of greater than 3 in 3 samples
physeqFile = '/home/bryan/PennRhiz/data/run1/phyloseq/buckleylab_pipeline/PennRhiz_thresh.rds'
```


```{r}
register(MulticoreParam(14))
```


# Differential abundance between bare soil and rhizosphere
## load phyloseq object and remove T0 points
```{r}
# read in phyloseq object
physeq.Full = readRDS(physeqFile)

# remove T0 as rhizosphere is not established
physeq.Full = subset_samples(physeq.Full, TimePoint != "T0")

#re-order levels 
sample_data(physeq.Full)$Genotype = relevel(sample_data(physeq.Full)$Genotype, "BARE")

sample_data(physeq.Full)$Rep = as.factor(sample_data(physeq.Full)$Rep)

```

## Function for creating l2f
```{r}
asNumeric = function(x) { as.numeric(as.character(x)) }

get_Ps = function(physeq.obj) {
    diagdds = phyloseq_to_deseq2(physeq.obj, ~Rep + Genotype)
    diagdds = DESeq(diagdds, quiet = TRUE, parallel = TRUE)
    r = results(diagdds, independentFiltering = TRUE, parallel = TRUE, lfcThreshold=.5,   
    altHypothesis="greaterAbs")
    #r = results(diagdds, independentFiltering = TRUE, parallel = TRUE)
    df = as.data.frame(r[, c("baseMean", "log2FoldChange", "pvalue", "padj")])
    df$OTU = rownames(df)
    
    return(df)
}

#Function to trim physeq object to just samples to include in Deseq analysis
deseq_prune = function(physeq.obj, plant, timepoint) {
    physeq.md = sample_data(physeq.obj)
    p = prune_samples((physeq.md$Genotype %in% c("BARE", plant))&
                     (physeq.md$TimePoint == timepoint), physeq.obj)
    p.thresh = filter_taxa(p, function(x) sum(x > 0) > 0, TRUE)
    return(p.thresh)
}

```

## Loop through time points and compare each plant to bare soil
```{r}
Sd = sample_data(physeq.Full) %>% as.data.frame()
Sd$TimePoint
TP = levels(as.factor(Sd$TimePoint))
# res.list = vector("list", length(TP))
# names(res.list) = as.character(TP)
# res.list


df_plant = data.frame()


for (timepoint in TP) {
    #print(day) ##need to remove
    Sd.d = Sd[Sd$TimePoint == timepoint,]
    Sd.d = Sd.d[Sd.d$Genotype != "BARE"]
    Plants = levels(Sd.d$Genotype) 
    
    # res.list.list = NULL        
    # res.list.list = vector("list", length(Plants))
    # names(res.list) = Plants

    
    for (plant in Plants) {
        DF = NULL
        
        #Trim physeq object by to day-plant combo 
        physeq.plant = deseq_prune(physeq.Full, plant, timepoint)
        
     
      
      
         #re-order levels
        sample_data(physeq.plant)$Plant = relevel(sample_data(physeq.plant)$Plant, "BARE")

        #convert to deseq using function above
        DF = get_Ps(physeq.plant)

        supp = tax_table(physeq.plant)
            if (!setequal(row.names(DF), row.names(supp))) {
            stop("Ordination and supplementary data indices differ on the following:\n.",
            setdiff(row.names(DF), row.names(supp)))}


        DF = data.frame(DF, supp)
        DF$OTU = rownames(DF)
        DF$TimePoint = timepoint
        DF$Genotype = plant
        df_plant = rbind(df_plant, DF)
        
    }

}
 



```
```{r}
setwd(workDir)
write.table(df_plant, "bare-plant.csv", row.names = FALSE, sep = ",")
```


```{r, fig.width = 9, fig.height = 10}
colourCount = length(unique(df_plant$Rank2)) + 1
getPalette = colorRampPalette(brewer.pal(10, "Paired"))

df.sig = df_plant[df_plant$padj < .05,] %>% filter(Genotype %in% c("B73xB97", "B73xTx303", 
                                               "SORSUD", "ECHES", "HELAN", "FAGES"))
df.ns = df_plant[df_plant$padj >= .05,] %>% filter(Genotype %in% c("B73xB97", "B73xTx303", 
                                               "SORSUD", "ECHES", "HELAN", "FAGES"))
df.sig$Genotype = df.sig$Genotype %>% as.factor %>% droplevels()
df.ns$Genotype = df.ns$Genotype %>% as.factor %>%droplevels()

p = ggplot(df_plant)+
    geom_point(data = df.ns, aes(Rank2, log2FoldChange, color = "Gray", position = "jitter")) +
    scale_shape_identity() +
    geom_point(data = df.sig, aes(Rank2, log2FoldChange, color = Rank2, position = "jitter")) +
    
               #geom_hline(y_intercept = .4) +
    
    facet_grid(TimePoint~Genotype)+
    theme(axis.text.x = element_blank(),
          legend.position = "bottom") +
    labs(y = "log[2] Fold Change") 

p = p + scale_color_manual(values = getPalette(colourCount))
p
```

# Basic summary
## number enriched and number decreased
```{r}
RhizResponders = df_plant %>% 
    filter(padj < 0.05 & log2FoldChange > 0) %>%
    .$OTU %>%
    unique() 

paste("Number of OTUs enriched in the rhizosphere: ", length(RhizResponders), sep = "") %>%
    print


BulkResponders = df_plant %>% 
    filter(padj < 0.05 & log2FoldChange < 0) %>%
    .$OTU %>%
    unique() 

paste("Number of OTUs enriched in the bulk soil: ", length(BulkResponders), sep = "") %>%
    print
 

setwd(workDir)
write.csv(RhizResponders,file = "RhizResponders.csv", sep = ",")   
```


```{r}
temp = df_plant %>% 
    filter(padj < 0.05) %>%
    mutate(Direction = ifelse(log2FoldChange < 0, "Decrease", "Increase")) %>%
    as.data.frame() %>%
    group_by(TimePoint, Rank2, Direction) %>%
    dplyr::summarize(Count = length(OTU)) %>%
    dplyr::arrange(desc(Direction), -Count)
temp

# how many are specific to just one time point

```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
