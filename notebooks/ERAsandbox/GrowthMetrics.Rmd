---
title: "R Notebook"
output:
  html_notebook: default
  pdf_document: default
---



```{r, echo = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(gridExtra)
library(reshape2)
library(lme4)
library(lmerTest)
library(lsmeans)
library(RColorBrewer)
```

```{r, echo= FALSE}
# theme function
theme_pub = function (base_size = 11, base_family = "Helvetica") {
    theme_grey(base_size = base_size, base_family = base_family) %+replace% 
        theme(
            axis.line.x = element_line(size = .5),
            axis.line.y = element_line(size = .5),
            panel.background = element_rect(fill = "white", colour = NA), 
            panel.border = element_rect(fill = NA, color = "black", size = .5), 
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), 
            strip.background = element_rect(fill = "grey85", 
                colour = "grey20"), 
            legend.key = element_rect(fill = "white", 
                colour = NA), complete = TRUE)
}
# Color palette
FertColors =  c("red", "green", "blue")

```


Data wrangling
```{r, echo = FALSE, results = "hide"}

Tbl1 = read.csv("/home/bryan/ERA/Master.csv", header = TRUE)

#Primary plants (no untreated, no high/low density)
Data = Tbl1 %>% filter(SeedTreatment == "Treated" & !Plant %in% c("322U", "330-High", "330-Low", "3475U", "354U", "34N42U", "P1151HR-High", "P1151HR-Low"))

Data$Plant = droplevels(Data$Plant)


# set plant levels by year
Data = Data %>%
                   # sort  dataframe
  mutate(Plant = reorder(Plant,R_Year),
         Genotype = reorder(Genotype, R_Year)) # reset your factor-column based on that order

Data$Plant %>% unique

Data$Fert = as.factor(Data$Fert)
colnames(Data)
```
```{r}
Data = Data %>% 
    #select %>% (-Total_kgSoilN_ha) %>%
        mutate(Grain_kgN_ha = Grain_kgdw_ha*Grain_FracN.leco,
                    Stover_kgN_ha = Stover_kgdw_ha*Stover_FracN.leco,
                    Cob_kgN_ha = Cob_kgdw_ha *Stover_FracN.leco,
                    Final_kgN_ha = Grain_kgN_ha + Stover_kgN_ha + Cob_kgN_ha,
                    Grain_kgFertN_ha= Grain_FracN_fromFert * grain_FracN*Grain_kgdw_ha,
                    Stover_kgFertN_ha = Stover_FracN_fromFert * stover_FracN*Stover_kgdw_ha,
                    Total_kgFertN_ha = Grain_kgFertN_ha + Stover_kgFertN_ha,
                    Total_kgSoilN_ha = Grain_kgSoilN_ha + Stover_kgSoilN_ha)

```


# Physiological maturity
* Testing main effects of fertilizer and year of release
* Including primary experimental plots, i.e. no untreated seed plots and no density comparisons

## Biomass

### Models
```{r, echo = FALSE, results = "hide"}
m1 = lmer(Total_kgdw_ha ~ Fert + R_Year + (1|Rep)  + (1|Rep:Row:Pos),  data = Data, na.action = na.exclude)
  #anova(m1, ddf = "Kenward-Roger") 
 
  #summary(m1) %>% print
  #plot(m1, title = "TotalBiomass") %>% print
  
m2 = lmer(Stover_kgdw_ha ~ Fert + R_Year + (1|Rep)  + (1|Rep:Row:Pos),  data = Data, na.action = na.exclude)
  #anova(m2, ddf = "Kenward-Roger") 
  
  # summary(m2) %>% print
  #plot(m2, title = "TotalBiomass") %>% print
  
m3 = lmer(Grain_kgdw_ha ~ Fert*R_Year + (1|Rep)  + (1|Rep:Row:Pos),  data = Data, na.action = na.exclude)
  #anova(m3, ddf = "Kenward-Roger")
  
  # summary(m3) %>% print
  #plot(m3, title = "TotalBiomass") %>% print
  
  
```

Total Biomass
```{r, echo = FALSE}
m1@call
anova(m1, ddf = "Kenward-Roger")
```

Stover Biomass
```{r, echo=FALSE}
m2@call
anova(m2, ddf = "Kenward-Roger")
```

Grain Biomass
```{r, echo = FALSE}
m3@call
anova(m3, ddf = "Kenward-Roger")
```

* Fert is not significant when interaction is included, even though it still describes a considerable portion of the variance, probably because of intercept set at R_Year = 0.  


### Plotting
```{r, echo = FALSE}

p = ggplot(Data, aes(x = R_Year, y = Total_kgdw_ha, color = Fert))+
    geom_point() +
    theme_pub() +
    scale_color_manual(values = FertColors) +
    stat_smooth(method = "lm")# +
    #facet_wrap(~Fert, ncol =1, scales = "free_y")

p1 = ggplot(Data, aes(x = R_Year, y = Stover_kgdw_ha, color = Fert))+
    geom_point() +
    theme_pub() +
    scale_color_manual(values = FertColors) +
    stat_smooth(method = "lm")

p2 = ggplot(Data, aes(x = R_Year, y = Grain_kgdw_ha, color = Fert))+
    geom_point() +
    theme_pub() +
    scale_color_manual(values = FertColors) +
    stat_smooth(method = "lm")

grid.arrange(p,p1,p2, ncol = 2)

```


## Nuptake 

* removing one outlier with inconsistent %N between Davis and Leco

### Modeling N uptake
```{r, echo = FALSE, results = "hide"}
sub = Data %>% filter(PlotIndex != 217)
m1 = lmer(log(Final_kgN_ha) ~  Fert + R_Year + (1|Rep)  + (1|Rep:Row:Pos),  data = sub, na.action = na.exclude)
  anova(m1, ddf = "Kenward-Roger")
  #summary(m1) %>% print
  plot(m1, title = "Final_kgN_ha") %>% print

m2 = lmer(log(Stover_kgN_ha) ~  Fert*R_Year + (1|Rep)  + (1|Rep:Row:Pos),  data = sub, na.action = na.exclude)  
  anova(m2, ddf = "Kenward-Roger")
  #summary(m1) %>% print
  plot(m2, title = "Stover_kgN_ha") %>% print

m3 = lmer(log(Grain_kgN_ha) ~  Fert + R_Year + (1|Rep)  + (1|Rep:Row:Pos),  data = sub, na.action = na.exclude)
  anova(m3, ddf = "Kenward-Roger")
  #summary(m1) %>% print
  plot(m3, title = "Grain_kgN_ha") %>% print
  
```

Total N uptake
```{r, echo=FALSE}
m1@call

anova(m1, ddf = "Kenward-Roger")
```

Total N in stover
```{r, echo=FALSE}
m2@call

anova(m2, ddf = "Kenward-Roger")
```


Total N in grain
```{r, echo=FALSE}
m3@call

anova(m3, ddf = "Kenward-Roger")
```

### Plotting N uptake
```{r, echo = FALSE}
sub = Data %>% filter(PlotIndex != 217)
p = ggplot(sub, aes(x = R_Year, y = Final_kgN_ha, color = Fert))+
    geom_point() +
    theme_pub() +
    ggtitle("Total N uptake") +
    scale_color_manual(values = FertColors)+
    stat_smooth(method = "lm")# +
    #facet_wrap(~Fert, ncol =1, scales = "free_y")

p1 = ggplot(sub, aes(x = R_Year, y = Grain_kgN_ha, color = Fert))+
    geom_point() +
    theme_pub() +
    ggtitle("Grain N")+
    scale_color_manual(values = FertColors)+
    stat_smooth(method = "lm")

p2 = ggplot(sub, aes(x = R_Year, y = Stover_kgN_ha, color = Fert))+
    geom_point() +
    theme_pub() +
    ggtitle("Stover N")+
    scale_color_manual(values = FertColors)+
    stat_smooth(method = "lm")

grid.arrange(p, p1, p2, ncol = 2)



```

## Partitioning N from soil and fertilizer
### Models
Total N uptake from soil in fertilized plots:
```{r, echo = FALSE, results = "hide"}
sub = Data %>% filter(Fert != 0)
m1 = lmer(log(Total_kgSoilN_ha) ~  Fert + R_Year + (1|Rep)  + (1|Rep:Row:Pos),  data = sub, na.action = na.exclude)
  anova(m1, ddf = "Kenward-Roger")
  summary(m1) %>% print
  plot(m1, title = "Final_kgN_ha") %>% print
```
```{r, echo = FALSE}
m1@call
anova(m1, ddf = "Kenward-Roger")
```


### Plotting N partitiioning
```{r, echo = FALSE}
sub = Data %>% filter(Fert!= "0")
  
p1 = sub %>% 
  ggplot(aes(x = R_Year, y = Total_kgSoilN_ha, color = Fert))+
    scale_color_manual(values = FertColors[2:3])+
    geom_point() +
    theme_pub() +
    ggtitle("Total Soil N") +
    theme(legend.position = "none")+
    stat_smooth(method = "lm")# +
    #facet_wrap(~Fert, ncol =1, scales = "free_y")


p2 = sub %>% 
  ggplot(aes(x = R_Year, y = Total_kgFertN_ha, color = Fert))+
    geom_point() +
  theme_pub() +
      ggtitle("Total Fertilizer N") +
    theme(legend.position = "right")+
    scale_color_manual(values = FertColors[2:3])+
    stat_smooth(method = "lm")# +
    #facet_wrap(~Fert, ncol =1, scales = "free_y")


p3 = sub %>% 
  ggplot(aes(x = R_Year, y = Grain_kgSoilN_ha, color = Fert))+
    geom_point() +
  theme_pub() +
    ggtitle("Soil N in Grain") +
    theme(legend.position = "none")+
    scale_color_manual(values = FertColors[2:3])+
    stat_smooth(method = "lm")# +
    #facet_wrap(~Fert, ncol =1, scales = "free_y")


p4 = sub %>%
  ggplot(aes(x = R_Year, y = Grain_kgFertN_ha, color = Fert))+
    geom_point() +
  theme_pub() +
    ggtitle("Fertilizer N in Grain") +
    theme(legend.position = "none")+
    scale_color_manual(values = FertColors[2:3])+
    stat_smooth(method = "lm")# +
    #facet_wrap(~Fert, ncol =1, scales = "free_y")


p5 = sub %>% 
  ggplot(aes(x = R_Year, y = Stover_kgSoilN_ha, color = Fert))+
    geom_point() +
  theme_pub() +
   ggtitle("Soil N in Stover") +
    theme(legend.position = "none")+
    scale_color_manual(values = FertColors[2:3])+
    stat_smooth(method = "lm")# +

p6 = sub %>% 
  ggplot(aes(x = R_Year, y = Stover_kgFertN_ha, color = Fert))+
    geom_point() +
  theme_pub() +
   ggtitle("Fertilizer N in Stover") +
    theme(legend.position = "none")+
    scale_color_manual(values = FertColors[2:3])+
    stat_smooth(method = "lm")# +


```

 
This is pretty cool, but I should run my calculations by you
```{r, fig.height = 9, fig.width = 8}
grid.arrange(p1, p2,p3,p4, p5, p6,ncol = 2)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
